name: Release Bundle

on:
  push:
    tags:
    - "v*"
  workflow_dispatch:


jobs:
  build-and-package:
    runs-on: windows-latest
    env:
      TICTACTOE_HEADLESS: "1"
    permissions:
      contents: write
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      id: python
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install -r requirements.txt

    - name: Run bundled CI script
      shell: pwsh
      run: |
        .\scripts\run-ci.ps1 -Python "${{ steps.python.outputs.python-path }}" -SkipRequirementsInstall

    - name: Zip installer artifacts
      shell: pwsh
      run: |
        if (-not (Test-Path dist)) {
            throw "Expected dist directory to exist after wheel-builder run."
        }
        $zipPath = Join-Path "dist" "yourapp-starter-artifacts.zip"
        if (Test-Path $zipPath) {
            Remove-Item $zipPath -Force
        }
        Compress-Archive -Path dist\* -DestinationPath $zipPath -Force
        Write-Host "Zipped artifacts -> $zipPath"

    - name: Upload workflow artifact
      uses: actions/upload-artifact@v4
      with:
        name: installer-bundle
        path: |
          dist/**

    - name: Attach release asset
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v2
      with:
        files: dist/yourapp-starter-artifacts.zip
